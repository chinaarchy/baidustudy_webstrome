<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>day31</title>
    <style>
        #result-table{
            border-color: black;
            border-width: thick;
        }
        #first-col{
            border-color: black;
            border: 1px;
            width: 100px;
        }
        td{
            border:2px black;
        }
    </style>
</head>
<body>
<div id="region-select">
    <input type="checkbox" value="华东" name="region" >华东
    <input type="checkbox" value="华北" name="region">华北
    <input type="checkbox" value="华南" name="region">华南
    <input type="checkbox" value="全选地区" name="region" class="all" checked="true">全选
</div>
<div id="product-select">
    <input type="checkbox" value="手机" name="product" >手机
    <input type="checkbox" value="笔记本" name="product">笔记本
    <input type="checkbox" value="智能音箱" name="product">智能音箱
    <input type="checkbox" value="全选商品" name="product" class="all" checked="true">全选
</div>
<div id="table-wrapper">
</div>

<script>
    let sourceData = [{
        product: "手机",
        region: "华东",
        sale: [120, 100, 140, 160, 180, 185, 190, 210, 230, 245, 255, 270]
    }, {
        product: "手机",
        region: "华北",
        sale: [80, 70, 90, 110, 130, 145, 150, 160, 170, 185, 190, 200]
    }, {
        product: "手机",
        region: "华南",
        sale: [220, 200, 240, 250, 260, 270, 280, 295, 310, 335, 355, 380]
    }, {
        product: "笔记本",
        region: "华东",
        sale: [50, 60, 80, 110, 30, 20, 70, 30, 420, 30, 20, 20]
    }, {
        product: "笔记本",
        region: "华北",
        sale: [30, 35, 50, 70, 20, 15, 30, 50, 710, 130, 20, 20]
    }, {
        product: "笔记本",
        region: "华南",
        sale: [80, 120, 130, 140, 70, 75, 120, 90, 550, 120, 110, 100]
    }, {
        product: "智能音箱",
        region: "华东",
        sale: [10, 30, 4, 5, 6, 5, 4, 5, 6, 5, 5, 25]
    }, {
        product: "智能音箱",
        region: "华北",
        sale: [15, 50, 15, 15, 12, 11, 11, 12, 12, 14, 12, 40]
    }, {
        product: "智能音箱",
        region: "华南",
        sale: [10, 40, 10, 6, 5, 6, 8, 6, 6, 6, 7, 26]
    }]
    var selectRegion = document.getElementsByName('region')
    var selectproduct = document.getElementsByName('product')
    var resultTable = document.getElementById('table-wrapper')
    var table = ''
    var sortByProduct =function (a,b) {
        if (a.product >= b.product){
            return 1
        } else if (a.product < b.product){
            return -1
        } else{
            return 0
        }
    };
    var sortByRegion = function (a,b) {
        if (a.region >= b.region){
            return 1
        } else if (a.region < b.region){
            return -1
        } else{
            return 0
        }
    }
    for (var i = 0; i < selectRegion.length; i++){
        selectRegion[i].addEventListener('click',function (e) {
            doSelect(e.target.checked,e.target.value,e.target.className)
        })
    }
    for (var i = 0; i < selectproduct.length; i++){
        selectproduct[i].addEventListener('click',function (e) {
            doSelect(e.target.checked,e.target.value,e.target.className)
        })
    }

    var doSelect = function (flag,changeThing,targetClassName) {
        resultTable.innerText = ''
        //checkbox的状态判断
        if (targetClassName == 'all') {
            toggleCheckbox(flag,changeThing)
        }else{
            checkCheckbox(changeThing)
        }
        //数据处理
        var result = []
        var countRegion = 0
        var countProduct = 3
        for (var i = 0; i < selectRegion.length - 1; i++){
            if (selectRegion[i].checked) {
                countRegion++
                for (var j in sourceData){
                    if (sourceData[j].region == selectRegion[i].value) {
                        result.push(sourceData[j])
                    }
                }
            }
        }
        for (var k = 0; k < selectproduct.length - 1; k++) {
            if (!selectproduct[k].checked) {
                countProduct--
                for (var l in result) {
                    if (result[l].product == selectproduct[k].value) {
                        result.splice(l, 1)
                    }
                }
            }
        }
        table = result
        showTable(result,countProduct,countRegion)

    }
    //点击全选的状态切换
    var toggleCheckbox = function (flag,changeThing) {
        if (flag){
            if (changeThing == '全选地区'){
                for (var i = 0; i < selectRegion.length - 1; i++){
                    selectRegion[i].checked = flag
                }
            }
            if (changeThing == '全选商品') {
                for (var i = 0; i < selectproduct.length - 1; i++){
                    selectproduct[i].checked = flag
                }
            }
        }
    }
    //判断选择的状态
    var checkCheckbox = function(changething){
        var count = 3
        var checkNode = document.querySelector(`input[value='${changething}']`).parentNode.getElementsByTagName('input')
        for(var i = 0; i < checkNode.length - 1; i++){
            if (checkNode[i].checked != true){
                count--
                checkNode[3].checked = false
            }
        }
        if (count == 0){
            for(var i = 0; i < checkNode.length - 1; i++) {
                if (checkNode[i].value == changething){
                    checkNode[i].checked = true
                }
            }
        }
        if (count == 3){
            checkNode[3].checked = true
        }
    }
    /*
    * 商品为单一时将商品作为第一列，并合并
    * 地区为单一时将地区为第一列，并合并
    * 都为一个时，商品第一，地区第二
    * 都多于一个时，商品第一，地区第二，并合并
    */
    var showTable = function(data,countProduct,countRegion){

        //进行判断
        if (countProduct <= countRegion){
            makeTable(countProduct,countRegion,true,data.sort(sortByProduct))
        } else {
            makeTable(countRegion,countProduct,false,data.sort(sortByRegion))
        }
    }

    var makeTable = function(numOfFirst,numOfSecond,tableType,data) {
        var tabNode = document.createElement("table");
        //插入表头
        var trHead = tabNode.insertRow();

        //插入数据
        var count = 0
        if (tableType) {
            trHead.innerHTML = `<table id="result-table"><tr><td>产品</td><td>地区</td><td>一月</td><td>二月</td><td>三月</td><td>四月</td><td>五月</td><td>六月</td><td>七月</td><td>八月</td><td>九月</td><td>十月</td><td>十一月</td><td>十二月</td></tr>`
            for (var x = 0; x < numOfFirst; x++) {
                for (var y = 0; y < numOfSecond; y++) {
                    var regions = data[count].region
                    var products = data[count].product
                    var sales = data[count].sale
                    var trBody = tabNode.insertRow();
                    var tableFirst = ''
                    if (y == 0) {
                        tableFirst = `<tr><td id="first-col" rowspan = ${numOfSecond}>${products}</td><td>${regions}</td>`
                    } else {
                        tableFirst = `<tr><td>${regions}</td>`
                    }
                    var t = `<td>${sales[0]}</td><td>${sales[1]}</td><td>${sales[2]}</td><td>${sales[3]}</td><td>${sales[4]}</td><td>${sales[5]}</td><td>${sales[6]}</td><td>${sales[7]}</td><td>${sales[8]}</td><td>${sales[9]}</td><td>${sales[10]}</td><td>${sales[11]}</td></tr>`
                    trBody.innerHTML = tableFirst + t
                    count++
                }
            }
        } else {
            trHead.innerHTML = `<table id="result-table"><tr><td>地区</td><td>产品</td><td>一月</td><td>二月</td><td>三月</td><td>四月</td><td>五月</td><td>六月</td><td>七月</td><td>八月</td><td>九月</td><td>十月</td><td>十一月</td><td>十二月</td></tr>`
            for (var x = 0; x < numOfFirst; x++) {
                for (var y = 0; y < numOfSecond; y++) {
                    var regions = data[count].region
                    var products = data[count].product
                    var sales = data[count].sale
                    var trBody = tabNode.insertRow();
                    var tableFirst = ''
                    if (y == 0) {
                        tableFirst = `<tr><td id="first-col" rowspan = ${numOfSecond}>${regions}</td><td>${products}</td>`
                    } else {
                        tableFirst = `<tr><td>${products}</td>`
                    }
                    var t = `<td>${sales[0]}</td><td>${sales[1]}</td><td>${sales[2]}</td><td>${sales[3]}</td><td>${sales[4]}</td><td>${sales[5]}</td><td>${sales[6]}</td><td>${sales[7]}</td><td>${sales[8]}</td><td>${sales[9]}</td><td>${sales[10]}</td><td>${sales[11]}</td></tr>`
                    trBody.innerHTML = tableFirst + t
                    count++
                }
            }
        }
        //页面插入表格
        resultTable.appendChild(tabNode)
    }
</script>

</select>
</body>
</html>